<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="./Styles/nav.css"/>
    <link rel="stylesheet" href="./Styles/footer.css"/>
    <link rel="stylesheet" href="./Styles/responsive.css"/>
    <link rel="stylesheet" href="./css/all.css">
    <title>Describe Your Problem - Medistar</title>
    <link rel="icon" href="./Files/Medistar-logo-crop.jpeg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js"></script>
    <style>
        .problem-description-container {
            min-height: 80vh;
            padding: 50px 20px;
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }
        
        .page-header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }
        
        .page-title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .page-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            padding: 0 20px;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin: 0 15px;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .step.active .step-number {
            background: #17a2b8;
            color: white;
        }
        
        .step.completed .step-number {
            background: #28a745;
            color: white;
        }
        
        .step-text {
            font-weight: 500;
            color: #6c757d;
        }
        
        .step.active .step-text {
            color: #17a2b8;
        }
        
        .step.completed .step-text {
            color: #28a745;
        }
        
        .step-connector {
            width: 60px;
            height: 2px;
            background: #e9ecef;
            margin: 0 10px;
        }
        
        .step.completed + .step-connector {
            background: #28a745;
        }
        
        .appointment-summary {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .summary-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .summary-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, #17a2b8, #138496);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            margin-right: 15px;
        }
        
        .summary-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }
        
        .summary-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .summary-item:last-child {
            border-bottom: none;
        }
        
        .summary-label {
            color: #666;
            font-weight: 500;
        }
        
        .summary-value {
            color: #333;
            font-weight: 600;
        }
        
        .description-form {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .form-section {
            margin-bottom: 30px;
        }
        
        .form-section h3 {
            color: #333;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #17a2b8;
        }
        
        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .symptoms-checklist {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .symptom-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .symptom-item:hover {
            border-color: #17a2b8;
            background: #f8f9fa;
        }
        
        .symptom-item.selected {
            border-color: #17a2b8;
            background: #e3f2fd;
        }
        
        .symptom-item input[type="checkbox"] {
            margin-right: 10px;
            width: auto;
        }
        
        .symptom-item label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
        }
        
        .character-count {
            text-align: right;
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .character-count.warning {
            color: #ffc107;
        }
        
        .character-count.danger {
            color: #dc3545;
        }
        
        .voice-recording-section {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }
        
        .voice-recording-section h4 {
            color: #17a2b8;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .recording-controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .recording-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .recording-buttons .btn {
            min-width: 140px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .recording-buttons .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .recording-buttons .btn:disabled {
            opacity: 0.6;
            transform: none;
            box-shadow: none;
        }
        
        .recording-status {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .timer-display {
            background: white;
            padding: 15px 25px;
            border-radius: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            font-size: 18px;
            font-weight: bold;
            color: #17a2b8;
            border: 2px solid #17a2b8;
        }
        
        .recording-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #dc3545;
            font-weight: 600;
        }
        
        .pulse-dot {
            width: 12px;
            height: 12px;
            background: #dc3545;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.7;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .audio-playback-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 2px solid #17a2b8;
        }
        
        .audio-playback-container audio {
            border-radius: 8px;
        }
        
        .recording-info {
            text-align: center;
        }
        
        .recording-tips .alert {
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
        }
        
        .recording-tips h6 {
            color: #0c5460;
            font-weight: bold;
        }
        
        .recording-tips ul {
            color: #0c5460;
        }
        
        .recording-tips li {
            margin-bottom: 5px;
        }
        
        /* Recording state styles */
        .recording-active .recording-buttons .btn-danger {
            background: #dc3545;
            animation: recording-pulse 2s infinite;
        }
        
        @keyframes recording-pulse {
            0%, 100% {
                background: #dc3545;
                box-shadow: 0 4px 6px rgba(220, 53, 69, 0.3);
            }
            50% {
                background: #c82333;
                box-shadow: 0 4px 15px rgba(220, 53, 69, 0.5);
            }
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .recording-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .recording-buttons .btn {
                width: 100%;
                max-width: 200px;
            }
            
            .recording-status {
                flex-direction: column;
                gap: 15px;
            }
            
            .timer-display {
                font-size: 16px;
                padding: 12px 20px;
            }
        }
        
        @media (max-width: 768px) {
            .step-indicator {
                flex-direction: column;
                align-items: center;
            }
            
            .step-connector {
                width: 2px;
                height: 20px;
                margin: 5px 0;
            }
            
            .page-title {
                font-size: 2rem;
            }
        }
    </style>
</head>

<body>
    <section id="navbar">
        <!-- Navbar Imported -->
    </section> 

    <div class="problem-description-container">
        <div class="container">
            <div class="page-header">
                <h1 class="page-title">Describe Your Problem</h1>
                <p class="page-subtitle">Help us understand your symptoms and medical concerns</p>
            </div>
            
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step completed">
                    <div class="step-number">✓</div>
                    <div class="step-text">Choose Doctor</div>
                </div>
                <div class="step-connector"></div>
                <div class="step completed">
                    <div class="step-number">✓</div>
                    <div class="step-text">Patient Details</div>
                </div>
                <div class="step-connector"></div>
                <div class="step active">
                    <div class="step-number">3</div>
                    <div class="step-text">Problem Description</div>
                </div>
                <div class="step-connector"></div>
                <div class="step">
                    <div class="step-number">4</div>
                    <div class="step-text">Payment</div>
                </div>
            </div>
            
            <!-- Appointment Summary -->
            <div class="appointment-summary">
                <div class="summary-header">
                    <div class="summary-icon">
                        <i class="fas fa-user-md"></i>
                    </div>
                    <h3 class="summary-title">Appointment Summary</h3>
                </div>
                <div class="summary-details" id="appointment-summary-details">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Problem Description Form -->
            <div class="description-form">
                <form id="problem-description-form">
                    <div class="form-section">
                        <h3><i class="fas fa-edit me-2"></i>Problem Description</h3>
                        <div class="form-group">
                            <label for="problem-description">Please describe your symptoms and medical concerns *</label>
                            <textarea 
                                id="problem-description" 
                                class="form-control" 
                                placeholder="Describe your symptoms, when they started, their severity, and any relevant medical history..."
                                maxlength="1000"
                                required
                            ></textarea>
                            <div class="character-count">
                                <span id="char-count">0</span>/1000 characters
                            </div>
                        </div>
                        
                        <!-- Voice Recording Section -->
                        <div class="voice-recording-section">
                            <h4><i class="fas fa-microphone me-2"></i>Voice Recording (Optional)</h4>
                            <p class="text-muted mb-3">Record your problem description instead of typing. Maximum 5 minutes.</p>
                            
                            <div class="recording-controls">
                                <div class="recording-buttons">
                                    <button type="button" id="recordBtn" class="btn btn-danger btn-lg">
                                        <i class="fas fa-microphone me-2"></i>Start Recording
                                    </button>
                                    <button type="button" id="stopBtn" class="btn btn-secondary btn-lg" disabled>
                                        <i class="fas fa-stop me-2"></i>Stop Recording
                                    </button>
                                    <button type="button" id="playBtn" class="btn btn-info btn-lg" disabled>
                                        <i class="fas fa-play me-2"></i>Play Recording
                                    </button>
                                    <button type="button" id="deleteBtn" class="btn btn-warning btn-lg" style="display: none;">
                                        <i class="fas fa-trash me-2"></i>Delete Recording
                                    </button>
                                </div>
                                
                                <div class="recording-status">
                                    <div class="timer-display">
                                        <span id="timerDisplay">00:00</span>
                                        <small class="text-muted">/ 05:00</small>
                                    </div>
                                    <div class="recording-indicator" id="recordingIndicator" style="display: none;">
                                        <div class="pulse-dot"></div>
                                        <span>Recording...</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="audio-playback-container" id="audioPlaybackContainer" style="display: none;">
                                <audio id="audioPlayback" controls style="width: 100%; margin-top: 15px;"></audio>
                                <div class="recording-info mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Recording saved. You can play it back or record a new one.
                                    </small>
                                </div>
                            </div>
                            
                            <div class="recording-tips mt-3">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-lightbulb me-2"></i>Recording Tips:</h6>
                                    <ul class="mb-0">
                                        <li>Speak clearly and at a normal pace</li>
                                        <li>Describe your symptoms in detail</li>
                                        <li>Mention when symptoms started</li>
                                        <li>Include any relevant medical history</li>
                                        <li>Find a quiet environment for better quality</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3><i class="fas fa-list-check me-2"></i>Common Symptoms</h3>
                        <p class="text-muted mb-3">Select any symptoms that apply to you:</p>
                        <div class="symptoms-checklist" id="symptoms-checklist">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3><i class="fas fa-history me-2"></i>Medical History</h3>
                        <div class="form-group">
                            <label for="medical-history">Any relevant medical history or previous conditions</label>
                            <textarea 
                                id="medical-history" 
                                class="form-control" 
                                placeholder="Previous surgeries, chronic conditions, allergies, medications..."
                                maxlength="500"
                            ></textarea>
                            <div class="character-count">
                                <span id="history-char-count">0</span>/500 characters
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3><i class="fas fa-calendar me-2"></i>Appointment Preferences</h3>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="preferred-date">Preferred Date *</label>
                                    <input type="date" id="preferred-date" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                        <div class="form-group">
                                    <label for="preferred-time">Preferred Time *</label>
                                    <select id="preferred-time" class="form-control" required>
                                        <option value="">Select Time</option>
                                        <option value="09:00">09:00 AM</option>
                                        <option value="10:00">10:00 AM</option>
                                        <option value="11:00">11:00 AM</option>
                                        <option value="12:00">12:00 PM</option>
                                        <option value="14:00">02:00 PM</option>
                                        <option value="15:00">03:00 PM</option>
                                        <option value="16:00">04:00 PM</option>
                                        <option value="17:00">05:00 PM</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-arrow-right me-2"></i>Continue to Payment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <section id="footer">
        <!-- Footer Imported -->
    </section>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
    <script>
        AOS.init();
        
        // Common symptoms list
        const commonSymptoms = [
            'Fever', 'Headache', 'Cough', 'Fatigue', 'Nausea', 'Dizziness',
            'Chest Pain', 'Shortness of Breath', 'Abdominal Pain', 'Back Pain',
            'Joint Pain', 'Skin Rash', 'Swelling', 'Numbness', 'Vision Problems',
            'Hearing Problems', 'Sleep Issues', 'Anxiety', 'Depression', 'Weight Loss'
        ];
        
        // Initialize page
        window.onload = function() {
            loadAppointmentSummary();
            setupSymptomsChecklist();
            setupCharacterCounters();
            setMinimumDate();
            initializeVoiceRecording();
        };
        
        // Voice Recording Variables
        let mediaRecorder, audioChunks = [], timer, seconds = 0;
        const maxSeconds = 300; // 5 minutes
        let audioBlob, audioUrl;
        let isRecording = false;
        
        // Voice Recording Elements
        const recordBtn = document.getElementById('recordBtn');
        const stopBtn = document.getElementById('stopBtn');
        const playBtn = document.getElementById('playBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        const timerDisplay = document.getElementById('timerDisplay');
        const audioPlayback = document.getElementById('audioPlayback');
        const audioPlaybackContainer = document.getElementById('audioPlaybackContainer');
        const recordingIndicator = document.getElementById('recordingIndicator');
        const voiceRecordingSection = document.querySelector('.voice-recording-section');
        
        // Initialize Voice Recording
        function initializeVoiceRecording() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showRecordingError('Audio recording is not supported in this browser. Please use a modern browser and ensure you are accessing this page over HTTPS.');
                return;
            }
            
            // Check for microphone permissions
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(() => {
                    setupRecordingControls();
                })
                .catch(() => {
                    showRecordingError('Microphone access denied. Please allow microphone permissions and refresh the page.');
                });
        }
        
        function setupRecordingControls() {
            recordBtn.disabled = false;
            stopBtn.disabled = true;
            playBtn.disabled = true;
            
            recordBtn.onclick = startRecording;
            stopBtn.onclick = stopRecording;
            playBtn.onclick = playRecording;
            deleteBtn.onclick = deleteRecording;
        }
        
        function showRecordingError(message) {
            if (typeof swal !== 'undefined') {
                swal("Recording Error", message, "warning");
            } else {
                alert("Recording Error: " + message);
            }
            recordBtn.disabled = true;
            stopBtn.disabled = true;
            playBtn.disabled = true;
        }
        
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus'
                });
                
                audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                
                mediaRecorder.onstop = () => {
                    audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    audioUrl = URL.createObjectURL(audioBlob);
                    audioPlayback.src = audioUrl;
                    audioPlaybackContainer.style.display = 'block';
                    playBtn.disabled = false;
                    deleteBtn.style.display = 'inline-block';
                    
                    // Update UI state
                    voiceRecordingSection.classList.remove('recording-active');
                    recordingIndicator.style.display = 'none';
                    
                    // Show success message
                    if (typeof swal !== 'undefined') {
                        swal("Recording Complete", "Your voice recording has been saved successfully!", "success");
                    } else {
                        alert("Recording Complete: Your voice recording has been saved successfully!");
                    }
                };
                
                mediaRecorder.start();
                isRecording = true;
                seconds = 0;
                timerDisplay.textContent = '00:00';
                
                // Start timer
                timer = setInterval(() => {
                    seconds++;
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = seconds % 60;
                    timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
                    
                    if (seconds >= maxSeconds) {
                        stopRecording();
                        if (typeof swal !== 'undefined') {
                            swal("Time Limit Reached", "Maximum recording time (5 minutes) reached. Recording stopped automatically.", "info");
                        } else {
                            alert("Time Limit Reached: Maximum recording time (5 minutes) reached. Recording stopped automatically.");
                        }
                    }
                }, 1000);
                
                // Update UI state
                recordBtn.disabled = true;
                stopBtn.disabled = false;
                voiceRecordingSection.classList.add('recording-active');
                recordingIndicator.style.display = 'flex';
                
            } catch (err) {
                console.error('Audio recording error:', err);
                showRecordingError('Could not start audio recording. Please check your browser permissions and try again.');
            }
        }
        
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
            
            clearInterval(timer);
            isRecording = false;
            recordBtn.disabled = false;
            stopBtn.disabled = true;
        }
        
        function playRecording() {
            if (audioPlayback.src) {
                audioPlayback.play();
            }
        }
        
        function deleteRecording() {
            const confirmMessage = "Are you sure you want to delete this recording?";
            let shouldDelete = false;
            
            if (typeof swal !== 'undefined') {
                swal({
                    title: "Delete Recording",
                    text: confirmMessage,
                    icon: "warning",
                    buttons: ["Cancel", "Delete"],
                    dangerMode: true,
                }).then((willDelete) => {
                    if (willDelete) {
                        performDelete();
                    }
                });
            } else {
                shouldDelete = confirm(confirmMessage);
                if (shouldDelete) {
                    performDelete();
                }
            }
        }
        
        function performDelete() {
            // Clean up
            if (audioUrl) {
                URL.revokeObjectURL(audioUrl);
            }
            audioBlob = null;
            audioUrl = null;
            
            // Reset UI
            audioPlaybackContainer.style.display = 'none';
            audioPlayback.src = '';
            playBtn.disabled = true;
            deleteBtn.style.display = 'none';
            timerDisplay.textContent = '00:00';
            
            if (typeof swal !== 'undefined') {
                swal("Recording Deleted", "Your voice recording has been deleted.", "success");
            } else {
                alert("Recording Deleted: Your voice recording has been deleted.");
            }
        }
        
        // Load and display appointment summary
        function loadAppointmentSummary() {
            const docObj = JSON.parse(localStorage.getItem('docObj'));
            const patientData = JSON.parse(localStorage.getItem('patientData'));
            
            if (!docObj || !patientData) {
                window.location.href = 'book.appointment.html';
                return;
            }
            
            const summaryHTML = `
                <div class="summary-item">
                    <span class="summary-label">Doctor:</span>
                    <span class="summary-value">${docObj.name}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Department:</span>
                    <span class="summary-value">${docObj.dept.replace('Department: ', '')}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Patient:</span>
                    <span class="summary-value">${patientData.firstName} ${patientData.lastName}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Age:</span>
                    <span class="summary-value">${patientData.age} years</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Gender:</span>
                    <span class="summary-value">${patientData.gender}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Phone:</span>
                    <span class="summary-value">${patientData.phone}</span>
                </div>
            `;
            
            document.getElementById('appointment-summary-details').innerHTML = summaryHTML;
        }
        
        // Setup symptoms checklist
        function setupSymptomsChecklist() {
            const checklistContainer = document.getElementById('symptoms-checklist');
            const symptomsHTML = commonSymptoms.map(symptom => `
                <div class="symptom-item">
                    <input type="checkbox" id="symptom-${symptom.toLowerCase().replace(' ', '-')}" value="${symptom}">
                    <label for="symptom-${symptom.toLowerCase().replace(' ', '-')}">${symptom}</label>
                </div>
            `).join('');
            
            checklistContainer.innerHTML = symptomsHTML;
            
            // Add click handlers for symptom items
            document.querySelectorAll('.symptom-item').forEach(item => {
                item.addEventListener('click', function() {
                    const checkbox = this.querySelector('input[type="checkbox"]');
                    checkbox.checked = !checkbox.checked;
                    this.classList.toggle('selected', checkbox.checked);
                });
            });
        }
        
        // Setup character counters
        function setupCharacterCounters() {
            const problemDesc = document.getElementById('problem-description');
            const medicalHistory = document.getElementById('medical-history');
            const charCount = document.getElementById('char-count');
            const historyCharCount = document.getElementById('history-char-count');
            
            problemDesc.addEventListener('input', function() {
                const count = this.value.length;
                charCount.textContent = count;
                charCount.className = 'character-count' + (count > 800 ? ' warning' : '') + (count > 950 ? ' danger' : '');
            });
            
            medicalHistory.addEventListener('input', function() {
                const count = this.value.length;
                historyCharCount.textContent = count;
                historyCharCount.className = 'character-count' + (count > 400 ? ' warning' : '') + (count > 450 ? ' danger' : '');
            });
        }
        
        // Set minimum date to today
        function setMinimumDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('preferred-date').min = today;
        }
        
        // Handle form submission
        document.getElementById('problem-description-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Collect form data
            const problemData = {
                description: document.getElementById('problem-description').value,
                medicalHistory: document.getElementById('medical-history').value,
                preferredDate: document.getElementById('preferred-date').value,
                preferredTime: document.getElementById('preferred-time').value,
                symptoms: Array.from(document.querySelectorAll('.symptom-item input[type="checkbox"]:checked'))
                    .map(checkbox => checkbox.value),
                voiceRecording: audioBlob ? {
                    blob: audioBlob,
                    duration: seconds,
                    timestamp: new Date().toISOString()
                } : null
            };
            
            // Validate that either text description or voice recording is provided
            if (!problemData.description.trim() && !problemData.voiceRecording) {
                if (typeof swal !== 'undefined') {
                    swal("Error", "Please provide either a text description or record your problem description.", "error");
                } else {
                    alert("Error: Please provide either a text description or record your problem description.");
                }
                return;
            }
            
            // Show loading state
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
            submitBtn.disabled = true;
            
            // Process voice recording if available
            if (problemData.voiceRecording) {
                uploadVoiceRecording(problemData.voiceRecording.blob)
                    .then(audioUrl => {
                        problemData.voiceRecording.audioUrl = audioUrl;
                        completeFormSubmission(problemData);
                    })
                    .catch(error => {
                        console.error('Voice recording upload failed:', error);
                        if (typeof swal !== 'undefined') {
                            swal("Upload Error", "Failed to upload voice recording. Please try again or use text description.", "error");
                        } else {
                            alert("Upload Error: Failed to upload voice recording. Please try again or use text description.");
                        }
                        resetSubmitButton(submitBtn, originalText);
                    });
            } else {
                completeFormSubmission(problemData);
            }
        });
        
        // Upload voice recording to Supabase storage
        async function uploadVoiceRecording(audioBlob) {
            try {
                // Create a unique filename
                const timestamp = new Date().getTime();
                const patientData = JSON.parse(localStorage.getItem('patientData'));
                const fileName = `voice-recording-${patientData.firstName}-${patientData.lastName}-${timestamp}.webm`;
                
                // Create FormData for file upload
                const formData = new FormData();
                formData.append('audio', audioBlob, fileName);
                formData.append('duration', seconds.toString());
                
                // Get auth token
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('Authentication token not found');
                }
                
                // Upload to backend API
                const response = await fetch('/api/audio/upload-voice-recording', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Upload failed');
                }
                
                const result = await response.json();
                
                // Store recording metadata in localStorage for form submission
                const recordingData = {
                    id: result.data.id,
                    fileName: result.data.fileName,
                    fileUrl: result.data.fileUrl,
                    fileSize: result.data.fileSize,
                    duration: result.data.duration,
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem('voiceRecording', JSON.stringify(recordingData));
                
                return result.data.fileUrl;
                
            } catch (error) {
                console.error('Error uploading voice recording:', error);
                
                // Fallback to localStorage if API fails
                console.log('Falling back to localStorage storage...');
                const audioDataUrl = await blobToDataURL(audioBlob);
                
                const recordingData = {
                    dataUrl: audioDataUrl,
                    fileName: `voice-recording-${Date.now()}.webm`,
                    timestamp: new Date().toISOString(),
                    size: audioBlob.size,
                    duration: seconds,
                    fallback: true
                };
                
                localStorage.setItem('voiceRecording', JSON.stringify(recordingData));
                
                return audioDataUrl;
            }
        }
        
        // Convert blob to data URL
        function blobToDataURL(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }
        
        // Complete form submission
        function completeFormSubmission(problemData) {
            // Store problem data
            localStorage.setItem('problemData', JSON.stringify(problemData));
            
            // Reset submit button
            const submitBtn = document.querySelector('button[type="submit"]');
            const originalText = '<i class="fas fa-arrow-right me-2"></i>Continue to Payment';
            resetSubmitButton(submitBtn, originalText);
            
            // Show success message
            if (typeof swal !== 'undefined') {
                swal("Success", "Your problem description has been saved successfully!", "success")
                    .then(() => {
                        // Redirect to payment
                        window.location.href = 'payment.html';
                    });
            } else {
                alert("Success: Your problem description has been saved successfully!");
                // Redirect to payment
                window.location.href = 'payment.html';
            }
        }
        
        // Reset submit button
        function resetSubmitButton(button, originalText) {
            button.innerHTML = originalText;
            button.disabled = false;
        }
    </script>
    <script type="module" src="./Scripts/navbar.js"></script>
    <script type="module" src="./Scripts/footer.js"></script>
</body>
</html> 